<div class="hide-after-grid grid-loading">
  <img src="images/loading.gif" alt="loading images" />
</div>
<div class="grid">
  <div class="grid-sizer"></div>
  {% for image in site.static_files %}
    {% if image.path contains page.masonry_path %}
      <div class="grid-item grid-index-{{ forloop.index }}" data-grid="{{ forloop.index }}">
        <img src="{{ image.path | slice: 1,image.path.size }}" alt="image" />
      </div>
    {% endif %}
  {% endfor %}
</div>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="js/jquery.touchSwipe.min.js"></script>
<script type="text/javascript" src="//unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script type="text/javascript" src="//unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>

<script>
  jQuery.fn.exists = function(){ return this.length > 0; }
  $('.grid').imagesLoaded(function(){
    $('.hide-after-grid').fadeOut(50);

    $('.grid').masonry({
      columnWidth: '.grid-sizer',
      itemSelector: '.grid-item',
      percentPosition: true
    });

    $('.grid').fadeIn(100);

    $('.grid').masonry();

    $('.show-after-grid').fadeIn(50);

    function setFocus(element) {
      $('.grid-item').addClass('grid-item--unfocus');
      $(element).removeClass('grid-item--unfocus');
      $(element).addClass('grid-item--focus');
    }

    $('.grid-item').click(function(){
      var focused = this.className.includes('focus');
      $('.grid-item').removeClass('grid-item--focus');
      if(!focused){
        setFocus(this);
      } else {
        $('.grid-item').removeClass('grid-item--unfocus');
      }
      // $grid.masonry();
    });

    function changeFocus(zoom){
      var focus = $('.grid-item--focus');
      if(focus.exists()){
        var newFocusId = parseInt(focus.data('grid')) + zoom;
        var newFocus = $('.grid-index-'+newFocusId);
        if(newFocus.exists()) {
          $(focus).removeClass('grid-item--focus');
          setFocus(newFocus);
        }
      }
    }

    $(".grid").swipe( {
      swipe:function(event, direction) {
        if(['left','up'].includes(direction)) {
          changeFocus(-1)
        } else {
          changeFocus(1)
        }
      }
    });

    $(document).keydown(function(e) {
      switch(e.which) {
        case 37: // left
        changeFocus(-1);
        break;

        case 39: // right
        changeFocus(1);
        break;

        default: return; // exit this handler for other keys
      }
    });
  });
</script>
